{#
    Shopping/index.twigに追記
    {{ include('@Stripe4/credit.twig', ignore_missing=true) }}
#}
{% if Order.Payment.getMethodClass == 'Plugin\\Stripe4\\Service\\Method\\CreditCard' %}
    <div class="ec-orderPayment">
        <div class="ec-rectHeading">
            <h2>クレジットカード情報</h2>
            <div class="ec-input">
                <script src="https://js.stripe.com/v3/"></script>
                <div class="form-row">
                    <div class="form-group">
                        <div id="card-number" class="form-control">
                            <!-- ここにクレジットカード番号入力欄が挿入される -->
                        </div>
                    </div>
                    <div class="form-group">
                        <div id="card-expiry" class="form-control">
                            <!-- ここにクレジットカード有効期限入力欄が挿入される -->
                        </div>
                    </div>
                    <div class="form-group">
                        <div id="card-cvc" class="form-control">
                            <!-- ここにクレジットカードセキュリティ番号入力欄が挿入される -->
                        </div>
                    </div>

                    <!-- ここにエラーメッセージが表示される -->
                    <div id="card-errors" role="alert"></div>
                </div>
                {{ form_widget(form.stripe_token) }}
            </div>
        </div>

        <script>
            var stripe = Stripe('{{ stripe_public_key }}');
            var elements = stripe.elements();

            // スタイルのカスタマイズ
            var style = {
                base: {
                    color: '#32325d',
                    fontFamily: '"Helvetica Neue", Helvetica, sans-serif',
                    fontSmoothing: 'antialiased',
                    '::placeholder': {
                        color: '#aab7c4'
                    }
                },
                invalid: {
                    color: '#fa755a',
                    iconColor: '#fa755a'
                }
            };

            // クレジットカード情報入力欄の構築
            const cardNumber = elements.create('cardNumber', {style: style, placeholder: 'カード番号 1111 1111 1111 1111'});
            cardNumber.mount("#card-number");

            const cardExpiry = elements.create('cardExpiry', {style: style, placeholder: '有効期限　MM/YY'});
            cardExpiry.mount("#card-expiry");

            const cardCvc = elements.create('cardCvc', {style: style, placeholder: 'セキュリティ番号'});
            cardCvc.mount("#card-cvc");

            // 入力変更時のリスナー
            // バリデーションメッセージを表示する
            cardNumber.addEventListener('change', function(event) {
                var displayError = document.getElementById('card-errors');
                if (event.error) {
                    displayError.textContent = event.error.message;
                } else {
                    displayError.textContent = '';
                }
            });

            cardExpiry.addEventListener('change', function(event) {
                var displayError = document.getElementById('card-errors');
                if (event.error) {
                    displayError.textContent = event.error.message;
                } else {
                    displayError.textContent = '';
                }
            });

            cardCvc.addEventListener('change', function(event) {
                var displayError = document.getElementById('card-errors');
                if (event.error) {
                    displayError.textContent = event.error.message;
                } else {
                    displayError.textContent = '';
                }
            });

            window.addEventListener("load", stripeCheckoutHandler, false);

            function stripeCheckoutHandler(e) {
                var selector = '#shopping-form > div > div.ec-orderRole__summary > div > div.ec-totalBox__btn > button';
                var jsInitCheckTimer = setInterval(jsLoaded, 1000);
                function jsLoaded() {
                    if (document.querySelector(selector) != null) {
                        clearInterval(jsInitCheckTimer);
                    }
                    // submit時のリスナー
                    var button = document.querySelector(selector);
                    button.addEventListener('click', function(event) {
                        event.preventDefault();

                        // Stripeサーバにクレジットカード情報を送信してクレジットカードトークンを取得する
                        stripe.createToken(cardNumber).then(function(result) {
                            if (result.error) {
                                var errorElement = document.getElementById('card-errors');
                                errorElement.textContent = result.error.message;
                                var overlay = document.querySelector('.bg-load-overlay');
                                overlay.remove();
                            } else {
                                // クレジットカードトークンをサーバにsubmitする
                                stripeTokenHandler(result.token);
                                setTimeout(function() {
                                    var form = document.getElementById('shopping-form');
                                    form.submit();
                                }, 1000);
                            }
                        });
                    });
                }
            }

            function stripeTokenHandler(token) {
                var form = document.getElementById('shopping-form');

                var stripe_token = document.getElementById('{{ form.stripe_token.vars.id }}');
                stripe_token.setAttribute('value', token.id);
            }
        </script>
    </div>
{% endif %}
